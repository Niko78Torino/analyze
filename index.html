import React, { useState, useEffect } from 'react';
import { GitBranch, FileCode, History, CheckCircle, XCircle, AlertTriangle, Loader, Shield, Zap, Bug, Wrench, Search, Globe, Accessibility, ChevronDown, Sparkles } from 'lucide-react';

// --- MOTORI DI ANALISI SIMULATI (COME PRIMA) ---
const runRepoAnalysis = (repoUrl) => {
    // ... (Il codice di analisi simulata rimane invariato)
    const randomScore = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    return {
        url: repoUrl,
        type: 'repository',
        overallScore: randomScore(65, 95),
        date: new Date().toISOString(),
        categories: {
            quality: { title: 'Qualit√† del Codice', score: randomScore(60, 98), icon: <Bug className="w-8 h-8 text-red-500" />, checks: [
                { id: 'linting', text: 'Errori di Linting', status: 'pass', description: 'Nessun errore critico di linting trovato.' },
                { id: 'code_smells', text: 'Code Smells', status: 'fail', description: `Rilevati ${randomScore(5, 15)} code smells.`, details: {
                    problem: 'Funzioni con troppe responsabilit√† e variabili non utilizzate.\n- src/utils/helpers.js:45 (Funzione "processData")\n- src/components/LegacyChart.jsx:112 (Componente con 500+ righe)',
                    solution: 'Effettuare il refactoring della funzione "processData" dividendola in funzioni pi√π piccole. Rimuovere le variabili non utilizzate e scomporre il componente LegacyChart.'
                }},
                { id: 'duplication', text: 'Duplicazione del Codice', status: 'warn', description: `Duplicazione del codice al 7%.`, details: {
                    problem: 'Blocchi di codice quasi identici trovati in pi√π file.\n- src/api/users.js\n- src/api/products.js',
                    solution: 'Estrarre la logica duplicata in una funzione di utility condivisa.'
                }},
            ]},
            security: { title: 'Sicurezza', score: randomScore(45, 95), icon: <Shield className="w-8 h-8 text-blue-500" />, checks: [
                { id: 'vulnerabilities', text: 'Vulnerabilit√† Note (CVEs)', status: 'fail', description: `Rilevate 2 vulnerabilit√† critiche.`, details: {
                    problem: 'La dipendenza "express" √® a una versione obsoleta (4.17.1), affetta da CVE-2022-24999 (Cross-Site Scripting).',
                    solution: 'Aggiornare immediatamente il pacchetto "express" alla versione pi√π recente e sicura.'
                }},
                { id: 'secrets', text: 'Secrets in-code', status: 'pass', description: 'Nessuna chiave API o credenziale hardcoded trovata.' },
            ]},
        }
    };
};
const runWebAppAnalysis = (webUrl) => {
    const randomScore = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
    return {
        url: webUrl,
        type: 'website',
        overallScore: randomScore(70, 90),
        date: new Date().toISOString(),
        categories: {
            performance: { title: 'Performance Web', score: randomScore(60, 80), icon: <Zap className="w-8 h-8 text-green-500" />, checks: [
                { id: 'core_web_vitals', text: 'Core Web Vitals', status: 'fail', description: 'Il punteggio LCP (Largest Contentful Paint) √® superiore a 4s.', details: {
                    problem: 'L\'immagine principale (hero image) sulla homepage √® molto pesante (2.5MB) e non √® ottimizzata.',
                    solution: 'Comprimere l\'immagine, convertirla in formato WebP, e precaricarla nel <head>.'
                }},
            ]},
            accessibility: { title: 'Accessibilit√† (WCAG)', score: randomScore(70, 90), icon: <Accessibility className="w-8 h-8 text-indigo-500" />, checks: [
                { id: 'contrast', text: 'Contrasto Colori', status: 'warn', description: 'Alcuni testi hanno un basso contrasto.', details: {
                    problem: 'Il testo grigio chiaro (#999999) su sfondo bianco nel footer non rispetta il rapporto di contrasto minimo di 4.5:1.',
                    solution: 'Scurire il colore del testo del footer ad almeno #767676 per garantire la leggibilit√†.'
                }},
            ]},
        }
    };
};


// --- COMPONENTI UI (CON MODIFICHE) ---

const StatusIcon = ({ status }) => {
    switch (status) {
        case 'pass': return <CheckCircle className="text-green-500 w-5 h-5 flex-shrink-0" />;
        case 'warn': return <AlertTriangle className="text-yellow-500 w-5 h-5 flex-shrink-0" />;
        case 'fail': return <XCircle className="text-red-500 w-5 h-5 flex-shrink-0" />;
        default: return null;
    }
};

const CheckItem = ({ check }) => {
    const [isOpen, setIsOpen] = useState(false);
    const [aiSuggestion, setAiSuggestion] = useState('');
    const [isLoadingAi, setIsLoadingAi] = useState(false);
    const [aiError, setAiError] = useState('');

    const hasDetails = check.details && (check.status === 'warn' || check.status === 'fail');

    // NUOVA FUNZIONE: Chiama la Netlify Function per ottenere suggerimenti AI
    const getAiHelp = async () => {
        setIsLoadingAi(true);
        setAiError('');
        setAiSuggestion('');

        const userPrompt = `
            Fornisci una spiegazione dettagliata e un esempio di codice per risolvere il seguente problema di sviluppo software.
            Sii chiaro, conciso e formatta la risposta in Markdown.

            Problema:
            ${check.details.problem}

            Soluzione Iniziale Proposta:
            ${check.details.solution}
        `;

        try {
            // IMPORTANTE: Questa √® la chiamata sicura.
            // Chiama il nostro endpoint API, che Netlify reindirizzer√† alla funzione server.
            // Il codice del browser non vedr√† mai la chiave API.
            const response = await fetch('/api/getAISuggestion', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: userPrompt }),
            });

            if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(errorBody.error?.message || 'Errore durante la richiesta AI.');
            }

            const data = await response.json();
            
            // Estrae il testo dalla risposta di Gemini
            const suggestionText = data.candidates[0]?.content?.parts[0]?.text;
            if (suggestionText) {
                setAiSuggestion(suggestionText);
            } else {
                throw new Error("La risposta dell'AI non ha un formato valido.");
            }

        } catch (error) {
            console.error("Errore durante la chiamata alla funzione Netlify:", error);
            setAiError(error.message);
        } finally {
            setIsLoadingAi(false);
        }
    };


    return (
        <li className="flex flex-col">
            <div className="flex items-start space-x-3">
                <StatusIcon status={check.status} />
                <div className="flex-1">
                    <p className="font-semibold text-gray-700 dark:text-gray-300">{check.text}</p>
                    <p className="text-sm text-gray-500 dark:text-gray-400">{check.description}</p>
                    {hasDetails && (
                        <div className="flex items-center space-x-4 mt-1">
                            <button onClick={() => setIsOpen(!isOpen)} className="text-sm text-blue-600 dark:text-blue-400 hover:underline flex items-center">
                                {isOpen ? 'Nascondi Dettagli' : 'Mostra Dettagli'}
                                <ChevronDown className={`w-4 h-4 ml-1 transform transition-transform ${isOpen ? 'rotate-180' : ''}`} />
                            </button>
                            <button onClick={getAiHelp} disabled={isLoadingAi} className="text-sm text-purple-600 dark:text-purple-400 hover:underline flex items-center disabled:opacity-50 disabled:cursor-wait">
                                <Sparkles className="w-4 h-4 mr-1" />
                                {isLoadingAi ? 'Analisi AI...' : 'Ottieni Suggerimenti AI'}
                            </button>
                        </div>
                    )}
                </div>
            </div>
            {hasDetails && isOpen && (
                <div className="mt-2 ml-8 pl-4 border-l-2 border-gray-200 dark:border-gray-700">
                    <div className="bg-gray-100 dark:bg-gray-900/50 p-3 rounded-lg">
                        <h4 className="font-bold text-sm text-gray-800 dark:text-gray-200">Problema:</h4>
                        <pre className="whitespace-pre-wrap text-xs text-gray-600 dark:text-gray-300 font-mono my-1">{check.details.problem}</pre>
                        <h4 className="font-bold text-sm text-gray-800 dark:text-gray-200 mt-2">Soluzione Consigliata:</h4>
                        <p className="text-xs text-gray-600 dark:text-gray-300">{check.details.solution}</p>
                    </div>
                </div>
            )}
            {/* NUOVA SEZIONE: Mostra i risultati della chiamata AI */}
            {isLoadingAi && <div className="mt-2 ml-8 pl-4"><Loader className="animate-spin text-purple-500" /></div>}
            {aiError && <div className="mt-2 ml-8 pl-4 text-red-500 text-sm bg-red-100 dark:bg-red-900/50 p-2 rounded-md"><strong>Errore AI:</strong> {aiError}</div>}
            {aiSuggestion && (
                <div className="mt-2 ml-8 pl-4 border-l-2 border-purple-300 dark:border-purple-700">
                    <div className="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg prose prose-sm dark:prose-invert max-w-none">
                         <h4 className="flex items-center font-bold text-purple-800 dark:text-purple-200"><Sparkles className="w-5 h-5 mr-2"/> Suggerimento dall'AI</h4>
                         <div dangerouslySetInnerHTML={{ __html: aiSuggestion.replace(/\n/g, '<br />') }} />
                    </div>
                </div>
            )}
        </li>
    );
};


const ReportCard = ({ title, score, checks, icon }) => {
    const getScoreColor = (s) => {
        if (s >= 90) return 'text-green-500';
        if (s >= 70) return 'text-yellow-500';
        return 'text-red-500';
    };

    return (
        <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 hover:shadow-2xl transition-shadow duration-300">
            <div className="flex items-center justify-between mb-4">
                <div className="flex items-center space-x-3">{icon}<h3 className="text-xl font-bold text-gray-800 dark:text-white">{title}</h3></div>
                <span className={`text-2xl font-bold ${getScoreColor(score)}`}>{score}/100</span>
            </div>
            <ul className="space-y-4">
                {checks.map((check) => <CheckItem key={check.id} check={check} />)}
            </ul>
        </div>
    );
};

// --- ALTRI COMPONENTI (Dashboard, Report, HistoryPage, App) ---
// ... (Questi componenti rimangono per lo pi√π invariati)
const Dashboard = ({ onAnalyze, isLoading }) => {
    const [url, setUrl] = useState('');
    const [analysisType, setAnalysisType] = useState('repository');

    const handleSubmit = (e) => {
        e.preventDefault();
        if (url && !isLoading) {
            let finalUrl = url;
            if (analysisType === 'website' && !/^https?:\/\//i.test(url)) {
                finalUrl = 'https://' + url;
            }
            onAnalyze(finalUrl, analysisType);
        }
    };
    
    const typeConfig = {
        repository: { icon: <GitBranch />, placeholder: "es. https://github.com/utente/repository", buttonText: "Analizza Repository" },
        website: { icon: <Globe />, placeholder: "es. www.ilmiosito.it", buttonText: "Analizza Sito Web" }
    };

    return (
        <div className="flex flex-col items-center justify-center text-center p-4 md:p-8">
            <h1 className="text-4xl md:text-5xl font-extrabold text-gray-800 dark:text-white mb-3">Suite di Analisi Professionale</h1>
            <p className="text-lg text-gray-600 dark:text-gray-300 max-w-2xl mb-8">
                Questo strumento offre un'analisi approfondita per repository e siti web. Identifica vulnerabilit√†, problemi di performance e manutenibilit√†, fornendo soluzioni concrete per migliorare la qualit√† del tuo progetto.
            </p>
            <div className="flex items-center p-1 bg-gray-200 dark:bg-gray-700 rounded-full mb-8">
                <button onClick={() => setAnalysisType('repository')} className={`px-6 py-2 rounded-full font-semibold transition-colors ${analysisType === 'repository' ? 'bg-white dark:bg-gray-900 text-blue-600' : 'text-gray-600 dark:text-gray-300'}`}>Repository</button>
                <button onClick={() => setAnalysisType('website')} className={`px-6 py-2 rounded-full font-semibold transition-colors ${analysisType === 'website' ? 'bg-white dark:bg-gray-900 text-blue-600' : 'text-gray-600 dark:text-gray-300'}`}>Sito Web</button>
            </div>
            <form onSubmit={handleSubmit} className="w-full max-w-xl">
                <div className="relative">
                    <div className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">{typeConfig[analysisType].icon}</div>
                    <input type="text" value={url} onChange={(e) => setUrl(e.target.value)} placeholder={typeConfig[analysisType].placeholder} className="w-full pl-12 pr-48 py-4 text-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 border-2 border-gray-300 dark:border-gray-600 rounded-full focus:outline-none focus:ring-4 focus:ring-blue-500/50 transition-all duration-300"/>
                    <button type="submit" disabled={isLoading || !url} className="absolute right-2 top-1/2 -translate-y-1/2 bg-blue-600 text-white font-bold py-3 px-6 rounded-full hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500/50 disabled:bg-gray-400 disabled:cursor-not-allowed transition-all duration-300 flex items-center">
                        {isLoading ? <><Loader className="animate-spin mr-2" />Analisi...</> : typeConfig[analysisType].buttonText}
                    </button>
                </div>
            </form>
        </div>
    );
};

const Report = ({ report, onBack }) => {
    if (!report) return null;
    
    const getOverallScoreRingColor = (s) => {
        if (s >= 90) return 'stroke-green-500';
        if (s >= 70) return 'stroke-yellow-500';
        return 'stroke-red-500';
    };
    const circumference = 2 * Math.PI * 54;
    const strokeDashoffset = circumference - (report.overallScore / 100) * circumference;
    const reportTitle = report.type === 'repository' ? 'Rapporto di Analisi Qualit√†' : 'Rapporto di Analisi Web';
    const analyzedEntity = report.type === 'repository' ? 'Repository Analizzato:' : 'Sito Web Analizzato:';

    return (
        <div className="p-4 md:p-8 max-w-7xl mx-auto">
            <div className="flex justify-between items-center mb-6">
                 <h2 className="text-3xl font-bold text-gray-800 dark:text-white">{reportTitle}</h2>
                 <button onClick={onBack} className="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">Nuova Analisi</button>
            </div>
            <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8 flex flex-col md:flex-row items-center justify-between">
                <div className="mb-4 md:mb-0">
                    <p className="text-gray-500 dark:text-gray-400">{analyzedEntity}</p>
                    <a href={report.url} target="_blank" rel="noopener noreferrer" className="text-2xl font-bold text-blue-600 dark:text-blue-400 hover:underline break-all">{report.url}</a>
                    <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">Analisi del: {new Date(report.date).toLocaleString('it-IT')}</p>
                </div>
                <div className="flex items-center space-x-4">
                    <div className="relative w-32 h-32">
                        <svg className="w-full h-full" viewBox="0 0 120 120">
                            <circle className="stroke-current text-gray-200 dark:text-gray-700" cx="60" cy="60" r="54" fill="none" strokeWidth="12"></circle>
                            <circle className={`transform -rotate-90 origin-center ${getOverallScoreRingColor(report.overallScore)} transition-all duration-1000 ease-out`} cx="60" cy="60" r="54" fill="none" strokeWidth="12" strokeDasharray={circumference} strokeDashoffset={strokeDashoffset} strokeLinecap="round"></circle>
                        </svg>
                        <div className="absolute inset-0 flex items-center justify-center"><span className="text-3xl font-bold text-gray-800 dark:text-white">{report.overallScore}</span></div>
                    </div>
                    <div>
                        <h3 className="text-xl font-bold text-gray-800 dark:text-white">Punteggio Globale</h3>
                        <p className="text-gray-600 dark:text-gray-400">Indice di qualit√† generale.</p>
                    </div>
                </div>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                {Object.values(report.categories).map(cat => <ReportCard key={cat.title} title={cat.title} score={cat.score} checks={cat.checks} icon={cat.icon} />)}
            </div>
        </div>
    );
};

const HistoryPage = ({ history, onViewReport, onClearHistory }) => {
    return (
        <div className="p-4 md:p-8 max-w-4xl mx-auto">
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-3xl font-bold text-gray-800 dark:text-white">Cronologia Analisi</h2>
                {history.length > 0 && <button onClick={onClearHistory} className="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">Svuota Cronologia</button>}
            </div>
            {history.length === 0 ? (
                <div className="text-center bg-white dark:bg-gray-800 rounded-xl shadow-lg p-12">
                    <History className="mx-auto w-16 h-16 text-gray-400 mb-4" />
                    <h3 className="text-xl font-semibold text-gray-700 dark:text-gray-300">Nessuna analisi trovata.</h3>
                    <p className="text-gray-500 dark:text-gray-400">Inizia una nuova analisi per vederla qui.</p>
                </div>
            ) : (
                <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                    <ul className="divide-y divide-gray-200 dark:divide-gray-700">
                        {history.map((item, index) => (
                            <li key={index} className="p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors flex flex-col sm:flex-row justify-between items-start sm:items-center">
                                <div className="mb-2 sm:mb-0">
                                    <span className={`text-xs font-bold uppercase py-1 px-2 rounded-full ${item.type === 'repository' ? 'bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200' : 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-200'}`}>{item.type}</span>
                                    <p className="font-bold text-blue-600 dark:text-blue-400 break-all mt-1">{item.url}</p>
                                    <p className="text-sm text-gray-500 dark:text-gray-400">{new Date(item.date).toLocaleString('it-IT')}</p>
                                </div>
                                <button onClick={() => onViewReport(item)} className="bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800/50 transition-colors self-start sm:self-center">Vedi Report</button>
                            </li>
                        ))}
                    </ul>
                </div>
            )}
        </div>
    );
};

export default function App() {
    const [page, setPage] = useState('dashboard');
    const [currentReport, setCurrentReport] = useState(null);
    const [history, setHistory] = useState(() => {
        try {
            const savedHistory = localStorage.getItem('professionalAnalysisHistory');
            return savedHistory ? JSON.parse(savedHistory) : [];
        } catch (error) { console.error("Could not load history", error); return []; }
    });
    const [isLoading, setIsLoading] = useState(false);
    const [isDarkMode, setIsDarkMode] = useState(false);

    useEffect(() => {
        try {
            localStorage.setItem('professionalAnalysisHistory', JSON.stringify(history));
        } catch (error) { console.error("Could not save history", error); }
    }, [history]);

    useEffect(() => {
        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        setIsDarkMode(mediaQuery.matches);
        const handleChange = (e) => setIsDarkMode(e.matches);
        mediaQuery.addEventListener('change', handleChange);
        return () => mediaQuery.removeEventListener('change', handleChange);
    }, []);

    useEffect(() => {
        if (isDarkMode) { document.documentElement.classList.add('dark'); } 
        else { document.documentElement.classList.remove('dark'); }
    }, [isDarkMode]);

    const handleAnalyze = (url, type) => {
        setIsLoading(true);
        setTimeout(() => {
            const report = type === 'repository' ? runRepoAnalysis(url) : runWebAppAnalysis(url);
            setCurrentReport(report);
            setHistory(prevHistory => [report, ...prevHistory]);
            setPage('report');
            setIsLoading(false);
        }, 1500);
    };

    const handleViewReport = (report) => {
        setCurrentReport(report);
        setPage('report');
    };
    
    const handleClearHistory = () => setHistory([]);

    const renderPage = () => {
        switch (page) {
            case 'report': return <Report report={currentReport} onBack={() => setPage('dashboard')} />;
            case 'history': return <HistoryPage history={history} onViewReport={handleViewReport} onClearHistory={handleClearHistory} />;
            default: return <Dashboard onAnalyze={handleAnalyze} isLoading={isLoading} />;
        }
    };

    return (
        <div className={`min-h-screen bg-gray-50 dark:bg-gray-900 font-sans transition-colors duration-300 ${isDarkMode ? 'dark' : ''}`}>
            <header className="bg-white dark:bg-gray-800 shadow-md">
                <nav className="container mx-auto px-4 py-3 flex justify-between items-center">
                    <div className="flex items-center space-x-2">
                        <FileCode className="w-8 h-8 text-blue-600" />
                        <span className="text-xl font-bold text-gray-800 dark:text-white">Professional Analyzer</span>
                    </div>
                    <div className="flex items-center space-x-4">
                        <button onClick={() => setPage('dashboard')} className={`px-3 py-2 rounded-md text-sm font-medium ${page === 'dashboard' ? 'text-blue-600 dark:text-blue-400' : 'text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400'}`}>Dashboard</button>
                        <button onClick={() => setPage('history')} className={`px-3 py-2 rounded-md text-sm font-medium ${page === 'history' ? 'text-blue-600 dark:text-blue-400' : 'text-gray-600 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400'}`}>Cronologia</button>
                        <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">{isDarkMode ? '‚òÄÔ∏è' : 'üåô'}</button>
                    </div>
                </nav>
            </header>
            <main className="container mx-auto px-4 py-8">{renderPage()}</main>
            <footer className="text-center py-4 text-gray-500 dark:text-gray-400 text-sm">
                <p>&copy; 2025 Professional Analyzer. Dati a scopo dimostrativo.</p>
            </footer>
        </div>
    );
}
